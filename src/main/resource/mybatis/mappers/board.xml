<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">

<select id="getTotalCount" parameterType="map" resultType="int">
	<![CDATA[
		select count(*) 
		from board b 
		WHERE b.category = #{category_no } 
		]]>
		<if test="keyword != null and keyword !=''">
			<![CDATA[
				and (b.title like '%${keyword }%' or b.content like '%${keyword }%')
			]]>	
		</if>
</select>


<select id="getList" parameterType="map" resultType="boardvo">
	<choose>
		<when test="keyword != null and keyword !=''">
			<![CDATA[
				select b.board_no, b.category, b.title, b.content, b.regdate, b.hits ,b.users_no, u.nickname, (select count(*) from board_comments bc
																											   where b.board_no = bc.board_no) as count
				from board b, users u
				where b.category = #{category_no } and b.users_no = u.users_no and (b.title like "%${keyword }%" or b.content like "%${keyword }%")
				order by b.board_no DESC 
				limit #{currentPage }, 10 
			]]>
		</when>
		
		<otherwise>
			<![CDATA[
				select b.board_no, b.category, b.title, b.content, b.regdate, b.hits ,u.nickname, (select count(*) from board_comments bc
																								   where b.board_no = bc.board_no) as count
				from board b, users u
				where b.category = #{category_no } and b.users_no = u.users_no
				order by b.board_no DESC 
				limit #{currentPage }, 10 
			]]>
		</otherwise>
	</choose>
</select>

<insert id="writePost" parameterType="boardvo">
<![CDATA[
	insert into board(category, title, content, regdate, users_no) values (#{category } , #{title } , #{content } , now(), #{users_no })
]]>
</insert>


<select id="viewPost" parameterType="int" resultType="boardvo">
<![CDATA[
	select b.board_no, b.category, b.title, b.content, b.regdate, b.hits ,u.nickname, (select count(*) from board_comments bc
																					   where b.board_no = bc.board_no) as count
	from board b, users u where b.board_no = #{board_no} and b.users_no = u.users_no
]]>
</select>



<update id="increaseHits" parameterType="boardvo">

<![CDATA[
	update board set hits = #{hits }+ 1 where board_no = #{board_no }
]]>

</update>


<!--                 			Reply								 -->

<select id="fetchReply" parameterType="int" resultType="boardcommentsvo">

<![CDATA[
	select bc.comments_no, bc.content, bc.regdate, bc.board_no, bc.users_no, u.nickname, u.users_image, (select count(*) FROM board_chat bChat
																					  					 where bc.board_no = #{board_no } and bc.comments_no = bChat.comments_no) as count
	from board_comments bc, users u
	where bc.board_no = #{board_no } and bc.users_no = u.users_no
]]>

</select>

<insert id="writeReply" parameterType="boardcommentsvo">

<![CDATA[
	insert INTO board_comments(content, regdate, board_no, users_no) VALUES (#{content }, now(), #{board_no }, #{users_no })
]]>

    <selectKey resultType="int" keyProperty="comments_no" order="AFTER">
        SELECT LAST_INSERT_ID()  
    </selectKey>

</insert>

<select id="getReply" parameterType="int" resultType="boardcommentsvo">
<![CDATA[

	select bc.comments_no, bc.content, bc.regdate, bc.board_no, bc.users_no, u.nickname, u.users_image
	from board_comments bc, users u
	where bc.comments_no = #{comments_no } and bc.users_no = u.users_no

]]>
</select>

<select id="countReply" parameterType="int" resultType="int">
<![CDATA[

select count(*) from board_comments bc where bc.board_no= #{board_no }

]]>
</select>


<!--                 			Reply Chat							 -->

<select id="fetchReplyChat" parameterType="int" resultType="boardchatvo">
<![CDATA[

	select bc.board_chat_no, bc.content, bc.regdate, bc.comments_no, bc.users_no, u.nickname, u.users_image
 	from board_chat bc, users u 
 	where bc.comments_no = #{comments_no } and u.users_no = bc.users_no

]]>
</select>

<insert id="writeReplyChat" parameterType="boardchatvo">

<![CDATA[
	insert INTO board_chat(content, regdate, comments_no, users_no) VALUES (#{content }, now(), #{comments_no }, #{users_no })
]]>

    <selectKey resultType="int" keyProperty="board_chat_no" order="AFTER">
        SELECT LAST_INSERT_ID()  
    </selectKey>

</insert>

<select id="getReplyChat" parameterType="int" resultType="boardchatvo">
<![CDATA[

	select bc.board_chat_no, bc.content, bc.regdate, bc.comments_no, bc.users_no, u.nickname, u.users_image
	from board_chat bc, users u
	where bc.board_chat_no = #{board_chat_no } and bc.users_no = u.users_no

]]>
</select>

<select id="countReplyChat" parameterType="int" resultType="int">
<![CDATA[

select count(*) from board_chat bc where bc.comments_no = #{comments_no }

]]>
</select>



</mapper>